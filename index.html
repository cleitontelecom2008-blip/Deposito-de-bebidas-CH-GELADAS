<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CH Geladas | Empresa v2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :raiz {
            --primário: #3b82f6;
            --bg-dark: #07090e;
            --input-bg: #111827;
        }

        corpo {
            família de fontes: 'Plus Jakarta Sans', sem serifa;
            cor de fundo: var(--bg-dark);
            cor: #f8fafc;
            seleção do usuário: nenhuma;
            ação tátil: manipulação;
            -webkit-tap-highlight-color: transparente;
        }

        .vidro {
            fundo: rgba(15, 23, 42, 0.8);
            filtro de fundo: desfoque(20px);
            borda: 1px sólida rgba(255, 255, 255, 0.05);
        }

        .modal-overlay {
            fundo: rgba(0, 0, 0, 0.8);
            filtro de fundo: desfoque(5px);
            posição: fixa;
            inserção: 0;
            Índice z: 50;
            exibir: nenhum;
            alinhamento-itens: centro;
            justificar-conteúdo: centralizado;
            opacidade: 0;
            transição: opacidade 0,3s;
        }
        .modal-overlay.open {
            Exibir: flexível;
            opacidade: 1;
        }

        .campo-de-entrada {
            cor de fundo: var(--input-bg);
            borda: 1px sólida #1f2937;
            raio-da-borda: 1rem;
            preenchimento: 1rem;
            largura: 100%;
            Esboço: nenhum;
            transição: todos os 0,2s;
            cor: branca;
            tamanho da fonte: 0,9rem;
        }

        .input-field:focus { border-color: var(--primary); }

        .rótulo-azul {
            cor: #3b82f6;
            tamanho da fonte: 0,7rem;
            peso da fonte: 800;
            text-transform: maiúsculas;
            espaçamento entre letras: 0,05em;
            margem-inferior: 0,4rem;
            exibir: bloco;
            margem-esquerda: 0,5rem;
        }

        .tab-content { display: none !important; }
        .tab-content.active { display: block !important; animation: fadeIn 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .btn-ativo {
            fundo: rgba(59, 130, 246, 0.1);
            cor: #3b82f6;
            borda inferior: 2px sólida #3b82f6;
        }

        #tela-de-bloqueio {
            posição: fixa; recuo: 0; índice z: 9999;
            fundo: gradiente radial (círculo em 50% 50%, #1e293b 0%, #07090e 100%);
            exibir: flexível; alinhar itens: ao centro; justificar conteúdo: ao centro;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        
        .admin-only-ui { display: none !important; }
        body.is-admin .admin-only-ui { display: block !important; }
        body.is-admin .admin-only-flex { display: flex !important; }

        .drop-zone { border: 2px dashed #3b82f6; transition: all 0.3s; }
        .drop-zone:hover { background: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="min-h-screen">

    <audio id="audioVenda" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3" preload="auto"></audio>

    <!-- Tela de Bloqueio -->
    <div id="lock-screen">
        <div class="text-center p-10 glass rounded-[3rem] w-full max-w-sm mx-4 shadow-2xl border border-white/10">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-2xl">
                <i class="fas fa-key text-white text-3xl"></i>
            </div>
            <h1 class="text-2xl font-black mb-8 uppercase italic tracking-tighter">CH <span class="text-blue-500">GELADAS</span></h1>
            <input type="password" id="masterPass" maxlength="6" inputmode="numeric" class="w-full bg-slate-900 border border-slate-700 p-5 rounded-2xl text-center text-3xl mb-6 outline-none text-white tracking-[0.5em]" placeholder="•••" onkeyup="checkPin(this.value)">
            <button onclick="login()" class="w-full bg-blue-600 py-5 rounded-2xl font-black uppercase text-xs transition-all hover:bg-blue-500">Acessar ao Sistema</button>
            <p class="text-[9px] text-slate-500 mt-6 uppercase tracking-widest font-bold">Segurança Empresarial Local</p>
        </div>
    </div>

    <!-- Modal Pós Venda -->
    <div id="modalPosVenda" class="modal-overlay">
        <div class="glass p-8 rounded-[2.5rem] w-full max-w-md mx-4 text-center border border-white/10 shadow-2xl transform transition-all scale-100">
            <div class="w-16 h-16 bg-emerald-500/20 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-check text-2xl"></i>
            </div>
            <h2 class="text-2xl font-black text-white mb-2">Venda Realizada!</h2>
            <p class="text-slate-400 text-sm mb-8">O que deseja fazer agora?</p>
            
            <button onclick="enviarWhatsappUltimaVenda()" class="w-full bg-[#25D366] hover:bg-[#20bd5a] text-white py-4 rounded-xl font-black uppercase text-xs mb-3 flex items-center justify-center gap-2 transition-all">
                <i class="fab fa-whatsapp text-lg"></i> Enviar Comprovante
            </button>
            <button onclick="fecharModalPosVenda()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 py-4 rounded-xl font-black uppercase text-xs transition-all">
                Nova Venda
            </button>
        </div>
    </div>

    <!-- Modal Config WhatsApp -->
    <div id="modalConfigZap" class="modal-overlay">
        <div class="glass p-8 rounded-[2.5rem] w-full max-w-sm mx-4 border border-white/10 shadow-2xl">
            <h3 class="label-blue mb-6 !text-sm">Configuração do WhatsApp</h3>
            <p class="text-xs text-slate-400 mb-4">Insira o número com o código do país e DDD (apenas números). Ex: 5511999999999</p>
            <input type="tel" id="zapNumberInput" class="input-field mb-6" placeholder="55..." inputmode="numeric">
            <div class="flex gap-3">
                <button onclick="salvarConfigZap()" class="flex-1 bg-blue-600 py-3 rounded-xl font-black uppercase text-xs">Salvar</button>
                <button onclick="toggleModal('modalConfigZap')" class="flex-1 bg-slate-800 py-3 rounded-xl font-black uppercase text-xs text-slate-400">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal util Venda -->
    <div id="modalEditVenda" class="modal-overlay">
        <div class="glass p-8 rounded-[2.5rem] w-full max-w-sm mx-4 border border-white/10 shadow-2xl">
            <h3 class="label-blue mb-6 !text-sm text-amber-500">Editar Venda</h3>
            <input type="hidden" id="editVendaId">
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="label-blue">Data/Hora (Texto)</label>
                    <input type="text" id="editVendaData" class="input-field">
                </div>
                <div>
                    <label class="label-blue">Total (R$)</label>
                    <input type="number" id="editVendaTotal" class="input-field" step="0.01">
                </div>
                 <div>
                    <label class="label-blue">Lucro Estimado (R$)</label>
                    <input type="number" id="editVendaLucro" class="input-field" step="0.01">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="salvarEdicaoVenda()" class="flex-1 bg-amber-600 hover:bg-amber-500 py-3 rounded-xl font-black uppercase text-xs text-white">Atualizar</button>
                <button onclick="toggleModal('modalEditVenda')" class="flex-1 bg-slate-800 py-3 rounded-xl font-black uppercase text-xs text-slate-400">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <div id="app-content" class="hidden flex flex-col min-h-screen">
        <header class="bg-slate-900/50 backdrop-blur-xl border-b border-white/5 px-6 py-4 flex justify-between items-center sticky top-0 z-40">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center font-black text-sm shadow-lg shadow-blue-500/20">CH</div>
                <div>
                    <h2 class="text-[10px] font-black uppercase text-blue-500 tracking-widest leading-none mb-1" id="userRoleTitle">Acesso Verificado</h2>
                    <p id="liveClock" class="text-[10px] font-mono text-slate-500">00:00:00</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="location.reload()" title="Sair" class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white">
                    <i class="fas fa-power-off text-xs"></i>
                </button>
            </div>
        </header>

        <!-- Navegação -->
        <nav class="bg-slate-950 border-b border-white/5 flex overflow-x-auto no-scrollbar">
            <button onclick="switchTab('vendas')" class="tab-btn flex-1 px-4 py-5 text-[10px] font-black uppercase btn-active" data-tab="vendas">Vendas</button>
            <button onclick="switchTab('estoque')" class="tab-btn flex-1 px-4 py-5 text-[10px] font-black uppercase admin-only-ui" data-tab="estoque">Estoque</button>
            <button onclick="switchTab('financeiro')" class="tab-btn flex-1 px-4 py-5 text-[10px] font-black uppercase admin-only-ui" data-tab="financeiro">Financialiro</button>
            <button onclick="switchTab('ponto')" class="tab-btn flex-1 px-4 py-5 text-[10px] font-black uppercase" data-tab="ponto">Ponto</button>
            <button onclick="switchTab('dados')" class="tab-btn flex-1 px-4 py-5 text-[10px] font-black uppercase admin-only-ui" data-tab="dados">Dados</button>
        </nav>

        <main class="flex-1 p-4 lg:p-6 max-w-7xl mx-auto w-full">
            
            <!-- PDV / Vendas -->
            <section id="vendas" class="tab-content active">
                <div class="grid lg:grid-cols-12 gap-6">
                    <div class="lg:col-span-8 flex flex-col gap-4">
                        <div class="flex gap-2">
                            <input type="text" id="searchProd" oninput="renderCatalogo()" class="input-field" placeholder="Pesquisar sem estoque...">
                            <button onclick="toggleModal('modalConfigZap')" class="w-14 bg-slate-800 rounded-2xl flex items-center justify-center text-slate-400 hover:text-[#25D366] hover:bg-slate-700 transition-colors border border-white/5" title="Configurar WhatsApp">
                                <i class="fab fa-whatsapp text-xl"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 overflow-y-auto custom-scroll max-h-[60vh]" id="catalogoVenda"></div>
                    </div>
                    
                    <div class="lg:col-span-4">
                        <div class="glass p-6 rounded-[2.5rem] flex flex-col h-full sticky top-24 border border-white/5">
                            <h3 class="label-blue">Carrinho Atual</h3>
                            <div id="carrinhoLista" class="flex-1 overflow-y-auto space-y-3 mb-6 custom-scroll min-h-[250px]"></div>
                            <div class="pt-6 border-t border-white/10 text-center">
                                <h2 id="displayCartTotal" class="text-4xl font-black text-blue-500 mb-4">R$ 0,00</h2>
                                <button onclick="finalizarVenda()" id="btnFinalizar" disabled class="w-full py-5 rounded-2xl bg-slate-800 text-slate-500 font-black uppercase text-[11px] transition-all">Finalizar Venda</button>
                                <p class="text-[8px] text-slate-500 mt-3 uppercase font-bold tracking-widest">Gerador Automático de TXT ativado</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Estoque -->
            <section id="estoque" class="tab-content">
                <div class="max-w-3xl mx-auto">
                    <div class="bg-slate-900/40 p-8 rounded-[2.5rem] border border-white/5 mb-8">
                        <h3 class="label-blue mb-8" id="formEstoqueTitle">Novo Produto</h3>
                        <input type="hidden" id="editingProdId">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="label-blue">Designaçã</label>
                                <input type="text" id="pNome" class="input-field" placeholder="Ex: Cerveja Especial">
                            </div>
                            <div>
                                <label class="label-blue">Custo Compra (Un.)</label>
                                <input type="number" id="pCustoUn" class="input-field" placeholder="0.00">
                            </div>
                            <div>
                                <label class="label-blue">Estoque Inicial</label>
                                <input type="number" id="pQtdUn" class="input-field" placeholder="0">
                            </div>
                            <div>
                                <label class="label-blue">Preço de Venda (Un.)</label>
                                <input type="number" id="pPrecoUn" class="input-field" placeholder="0.00">
                            </div>
                        </div>

                        <div class="bg-black/20 p-6 rounded-3xl border border-white/5">
                            <h4 class="label-blue mb-4 text-blue-400">Pacotes de Venda</h4>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <input type="number" id="tempPackUn" class="input-field" placeholder="Qtd (ex: 6)">
                                <input type="number" id="tempPackPreco" class="input-field" placeholder="Preço do Pacote">
                            </div>
                            <button onclick="addPackToList()" class="w-full bg-slate-800 text-slate-300 py-3 rounded-xl font-bold text-[10px] uppercase">Adicionar Pacote</button>
                            <div id="tempPackList" class="mt-4 space-y-2"></div>
                        </div>

                        <div class="flex gap-4 mt-8">
                            <button id="btnSaveProd" onclick="saveProduto()" class="flex-1 bg-blue-600 py-5 rounded-2xl font-black uppercase text-xs">Cadastrar Produto</button>
                            <button id="btnCancelEdit" onclick="resetFormEstoque()" class="hidden bg-slate-800 px-8 rounded-2xl font-black uppercase text-xs text-slate-400">Cancelar</button>
                        </div>
                    </div>
                    
                    <div id="gridEstoque" class="grid md:grid-cols-2 gap-4"></div>
                </div>
            </section>

            <!-- Financeiro -->
            <section id="financeiro" class="tab-content">
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="glass p-8 rounded-[2.5rem] border-l-4 border-blue-500">
                        <span class="label-blue !ml-0">Investimento Total</span>
                        <input type="number" id="invTotalInput" onchange="updateInvestimento()" class="bg-transparent text-3xl font-black w-full outline-none text-white mt-2" placeholder="0.00">
                    </div>
                    <div class="glass p-8 rounded-[2.5rem] border-l-4 border-emerald-500">
                        <span class="label-blue !ml-0">Lucro Líquido</span>
                        <h2 id="dashLucro" class="text-3xl font-black mt-2 text-emerald-400">R$ 0,00</h2>
                    </div>
                    <div class="glass p-8 rounded-[2.5rem] border-l-4 border-amber-500">
                        <span class="label-blue !ml-0">ROI Global</span>
                        <h2 id="roiDisplay" class="text-3xl font-black mt-2 text-amber-400">0%</h2>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="glass p-8 rounded-[2.5rem] flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="label-blue !ml-0">Histórico de Vendas</h3>
                            <span class="text-[9px] bg-blue-500/10 text-blue-500 px-2 py-1 rounded-lg font-bold" id="totalVendasCount">0 reg</span>
                        </div>
                        <div class="space-y-3 overflow-y-auto custom-scroll max-h-[500px]" id="vendaLogs"></div>
                    </div>
                    <div class="glass p-8 rounded-[2.5rem] h-fit sticky top-24">
                        <h3 class="label-blue !ml-0 mb-6">Métricas e Açães</h3>
                        <div class="space-y-4">
                            <div class="p-4 bg-black/20 rounded-2xl flex justify-between border border-white/5">
                                <span class="text-[10px] uppercase font-bold text-slate-400">Faturaço Bruta</span>
                                <span id="faturacaoBruta" class="font-black">R$ 0,00</span>
                            </div>
                            <div class="p-4 bg-black/20 rounded-2xl flex justify-between border border-white/5">
                                <span class="text-[10px] uppercase font-bold text-slate-400">Ponto de Equilíbrio</span>
                                <span id="breakEvenStatus" class="font-black text-amber-500">R$ 0,00</span>
                            </div>
                             <button onclick="exportarRelatorioTxt()" class="w-full bg-emerald-600/10 text-emerald-500 py-3 rounded-xl font-bold text-[10px] uppercase border border-emerald-500/20 hover:bg-emerald-600/20 mt-4">
                                <i class="fas fa-file-alt mr-2"></i> Baixar Relatório TXT
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ponto -->
            <section id="ponto" class="tab-content">
                <div class="max-w-xl mx-auto">
                    <div class="glass p-10 rounded-[3rem] text-center border border-white/5">
                        <h3 class="label-blue !ml-0 mb-6 italic">Folha de Ponto</h3>
                        <input type="text" id="workerName" class="input-field text-center mb-6" placeholder="Nome do Funcionário">
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="registarPonto('ENTRADA')" class="bg-emerald-600 p-5 rounded-2xl font-black uppercase text-[11px]">Entrada</button>
                            <button onclick="registarPonto('SAÃ DA')" class="bg-red-600 p-5 rounded-2xl font-black uppercase text-[11px]">SaÃda</button>
                        </div>
                    </div>
                    <div id="pontoLogs" class="mt-8 space-y-2"></div>
                </div>
            </section>

             <!-- DADOS / BACKUP -->
            <section id="dados" class="tab-content">
                <div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-8">
                    <!-- Exportar -->
                    <div class="glass p-8 rounded-[2.5rem] border border-white/5 flex flex-col items-center text-center">
                        <div class="w-16 h-16 bg-blue-600/20 rounded-full flex items-center justify-center mb-6 text-blue-500">
                            <i class="fas fa-cloud-download-alt text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-black uppercase mb-2">Exportar Dados</h3>
                        <p class="text-xs text-slate-400 mb-8 max-w-[200px]">Crie um arquivo de segurança com todo o estoque, vendas e configurações.</p>
                        <button onclick="exportarBackup()" class="w-full bg-blue-600 py-4 rounded-xl font-black uppercase text-xs hover:bg-blue-500 transition-all">
                            Baixar Backup (.json)
                        </button>
                        <p class="text-[9px] text-slate-500 mt-4 font-bold">ÚLTIMO BACKUP: <span id="lastBackupInfo">Nunca</span></p>
                    </div>

                    <!-- Importar -->
                    <div class="glass p-8 rounded-[2.5rem] border border-white/5 flex flex-col items-center text-center drop-zone relative">
                        <div class="w-16 h-16 bg-emerald-600/20 rounded-full flex items-center justify-center mb-6 text-emerald-500">
                            <i class="fas fa-cloud-upload-alt text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-black uppercase mb-2">Importar Dados</h3>
                        <p class="text-xs text-slate-400 mb-8 max-w-[200px]">Carregue um arquivo .json para restaurar seus dados neste aparelho.</p>
                        
                        <!-- Correção de entrada -->
                        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importarDados(this)">
                        
                        <button onclick="document.getElementById('fileInput').click()" class="w-full bg-emerald-600 py-4 rounded-xl font-black uppercase text-xs hover:bg-emerald-500 transition-all mb-3">
                            Arquivo
                        </button>
                        <p class="text-[8px] text-red-400/60 font-bold uppercase tracking-widest"><i class="fas fa-exclamation-triangle mr-1"></i> Substitui dados atuais</p>
                    </div>
                    
                    <div class="md:col-span-2 glass p-6 rounded-[2rem] border border-white/5 text-center">
                         <h3 class="label-blue mb-4">Estatísticas do Sistema</h3>
                         <div class="grid grid-cols-3 gap-4">
                             <div class="bg-black/20 p-4 rounded-xl">
                                 <span class="block text-[8px] text-slate-500 uppercase font-bold">Total de Produtos</span>
                                 <span class="text-xl font-black" id="statProds">0</span>
                             </div>
                             <div class="bg-black/20 p-4 rounded-xl">
                                 <span class="block text-[8px] text-slate-500 uppercase font-bold">Total de Vendas</span>
                                 <span class="text-xl font-black" id="statVendas">0</span>
                             </div>
                             <div class="bg-black/20 p-4 rounded-xl">
                                 <span class="block text-[8px] text-slate-500 uppercase font-bold">Registos Ponto</span>
                                 <span class="text-xl font-black" id="statPonto">0</span>
                             </div>
                         </div>
                    </div>

                    <!-- ZONA DE PERIGO / RESET -->
                    <div class="md:col-span-2 glass p-8 rounded-[2rem] border border-red-500/20 relative overflow-hidden group">
                        <div class="absolute inset-0 bg-red-500/5 group-hover:bg-red-500/10 transition-all"></div>
                        <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6 text-center md:text-left">
                            <div>
                                <h3 class="text-lg font-black uppercase text-red-500 mb-1 flex items-center justify-center md:justify-start">
                                    <i class="fas fa-radiation mr-2"></i> Reiniciar Geral
                                </h3>
                                <p class="text-[10px] text-slate-400 font-bold max-w-md">
                                    Esta ação é irreversível. Apaga permanentemente todo o estoque, histórico de vendas, pontos e configurações. Use com cautela.
                                </p>
                            </div>
                            <button onclick="resetSistema()" class="bg-red-500/10 text-red-500 border border-red-500/50 py-4 px-8 rounded-xl font-black uppercase text-xs hover:bg-red-600 hover:text-white hover:border-red-600 transition-all whitespace-nowrap shadow-lg shadow-red-500/10">
                                <i class="fas fa-trash-alt mr-2"></i> Limpar todos os dados
                            </button>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 glass px-8 py-5 rounded-2xl flex items-center gap-4 z-[100] transition-all opacity-0 translate-y-20 pointer-events-none">
        <div id="toastIcon"></div>
        <div class="flex flex-col"><span class="text-[11px] font-black uppercase" id="toastMsg"></span><span class="text-[9px] text-slate-500 font-bold uppercase" id="toastSubMsg"></span></div>
    </div>

    <script>
        const STORAGE_KEY = 'CH_GELADAS_DB_ENTERPRISE';
        let db = { estoque: [], vendas: [], ponto: [], investimento: 0, config: { whatsapp: '' } };
        let carrinho = [];
        let tempPacks = [];
        seja isAdmin = falso;
        seja lastVenda = nulo;

        função init() {
            const saved = localStorage.getItem(STORAGE_KEY);
            se(salvo) {
                const parsed = JSON.parse(saved);
                db = { ...db, ...analisado };
                // Garantir estrutura de configuração
                if(!db.config) db.config = { whatsapp: '' };
            }
            
            // Garantir arrays
            if(!db.estoque) db.estoque = [];
            if(!db.vendas) db.vendas = [];
            if(!db.ponto) db.ponto = [];
            
            document.getElementById('invTotalInput').value = db.investimento || 0;
            document.getElementById('zapNumberInput').value = db.config.whatsapp || '';

            atualizarRelógio(); definirIntervalo(atualizarRelógio, 1000);
            atualizarEstatísticas();
            atualizarUI();
        }

        função verificarPino(val) {
            if(val === "001" || val === "12345") login();
        }

        função login() {
            const pin = document.getElementById('masterPass').value;
            se(pino === "001") {
                isAdmin = verdadeiro;
                document.body.classList.add('is-admin');
                document.getElementById('userRoleTitle').textContent = "ADMINISTRADOR";
            } senão se(pino === "12345") {
                isAdmin = falso;
                document.body.classList.remove('is-admin');
                document.getElementById('userRoleTitle').textContent = "COLABORADOR";
            } else { return; }

            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('app-content').classList.remove('hidden');
            showToast("Acesso OK", "Sessão iniciada");
        }

        função switchTab(id) {
            const btn = document.querySelector(`[data-tab="${id}"]`);
            if(btn.classList.contains('admin-only-ui') && !isAdmin) {
                showToast("Negado", "Apenas Administrador", "erro");
                retornar;
            }
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('btn-active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('btn-active');
            
            if(id === 'estoque') resetFormEstoque();
            if(id === 'dados') updateStats();
            if(id === 'financeiro') renderFinanceiro();
        }

        // --- CONFIGURAÇÃO DO WHATSAPP ---
        função toggleModal(id, forceClose = false) {
            const el = document.getElementById(id);
            se(forceClose) {
                el.classList.remove('open');
            } outro {
                el.classList.toggle('aberto');
            }
        }

        função salvarConfigZap() {
            const num = document.getElementById('zapNumberInput').value.replace(/\D/g,'');
            db.config.whatsapp = num;
            salvar();
            alternarModal('modalConfigZap');
            showToast("Configuração", "Número WhatsApp Salvo");
        }

        function enviarWhatsappUltimaVenda() {
            if(!lastSale || !db.config.whatsapp) {
                if(!db.config.whatsapp) showToast("Erro", "Configurar o WhatsApp na aba Vendas", "erro");
                retornar;
            }
            
            deixe msg = `*CH GELADAS | COMPROVANTE*\n`;
            mensagem += `ðŸ“… ${lastSale.data}\n`;
            mensagem += `--------------------------\n`;
            lastSale.itens.forEach(item => {
                msg += `${item.label === 'UNID' ? '1x' : item.label} ${item.nome} ... R$ ${item.preco.toFixed(2)}\n`;
            });
            mensagem += `--------------------------\n`;
            msg += `*TOTAL: R$ ${lastSale.total.toFixed(2)}*\n`;
            msg += `Obrigado pela preferência!`;

            const url = `https://wa.me/${db.config.whatsapp}?text=${encodeURIComponent(msg)}`;
            janela.abrir(url, '_blank');
            fecharModalPosVenda();
        }

        function fecharModalPosVenda() {
            toggleModal('modalPosVenda', true);
        }

        // --- ESTOQUE ---
        função adicionarPacoteÀLista() {
            const un = parseInt(document.getElementById('tempPackUn').value);
            const preco = parseFloat(document.getElementById('tempPackPreco').value);
            if(!un || !preco) return;
            tempPacks.push({ un, preco });
            document.getElementById('tempPackUn').value = "";
            document.getElementById('tempPackPreco').value = "";
            renderTempPacks();
        }

        função renderTempPacks() {
            const cont = document.getElementById('tempPackList');
            cont.innerHTML = tempPacks.map((p, i) => `
                <div class="flex justify-between items-center bg-black/40 p-3 rounded-xl border border-white/5">
                    <span class="text-[10px] font-bold">Pacote ${p.un} UN -> R$ ${p.preco.toFixed(2)}</span>
                    <button onclick="tempPacks.splice(${i},1); renderTempPacks();" class="text-red-500 text-xs px-2"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        função salvarProduto() {
            const nome = document.getElementById('pNome').value;
            const custoUn = parseFloat(document.getElementById('pCustoUn').value) || 0;
            const qtdUn = parseInt(document.getElementById('pQtdUn').value) || 0;
            const precoUn = parseFloat(document.getElementById('pPrecoUn').value) || 0;
            const editId = document.getElementById('editingProdId').value;

            if(!nome) return showToast("Erro", "Nome obrigatório", "erro");

            se(editId) {
                // Modo Edição
                const idx = db.estoque.findIndex(p => p.id == editId);
                se(idx !== -1) {
                    db.estoque[idx] = { ...db.estoque[idx], nome, custoUn, qtdUn, precoUn, packs: [...tempPacks] };
                    showToast("Sucesso", "Produto Atualizado");
                }
            } outro {
                // Novo Produto
                db.estoque.unshift({ id: Date.now(), nome, custoUn, qtdUn, precoUn, packs: [...tempPacks] });
                showToast("Estoque", "Produto Registrado");
            }

            resetFormEstoque();
            salvar();
        }

        função editarProduto(id) {
            const p = db.estoque.find(x => x.id == id);
            se(!p) retornar;

            document.getElementById('formEstoqueTitle').textContent = "Editar Produto";
            document.getElementById('editingProdId').value = p.id;
            document.getElementById('pNome').value = p.nome;
            document.getElementById('pCustoUn').value = p.custoUn;
            document.getElementById('pQtdUn').value = p.qtdUn;
            document.getElementById('pPrecoUn').value = p.precoUn;
            tempPacks = [...p.packs];
            renderTempPacks();

            document.getElementById('btnSaveProd').textContent = "Atualizar Produto";
            document.getElementById('btnCancelEdit').classList.remove('hidden');
            switchTab('estoque');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        função resetFormEstoque() {
            document.getElementById('formEstoqueTitle').textContent = "Novo Produto";
            document.getElementById('editingProdId').value = "";
            ['pNome', 'pCustoUn', 'pQtdUn', 'pPrecoUn'].forEach(id => document.getElementById(id).value = "");
            tempPacks = [];
            document.getElementById('tempPackList').innerHTML = "";
            document.getElementById('btnSaveProd').textContent = "Registar Produto";
            document.getElementById('btnCancelEdit').classList.add('hidden');
        }

        // --- VENDAS ---
        função renderizarCatálogo() {
            const search = document.getElementById('searchProd').value.toLowerCase();
            const cont = document.getElementById('catalogoVenda');
            const filtered = db.estoque.filter(p => p.nome.toLowerCase().includes(search));
            cont.innerHTML = filtered.map(p => `
                <div class="glass p-5 rounded-2xl border-l-4 border-blue-500">
                    <p class="text-[10px] font-black uppercase text-slate-300 mb-4">${p.nome} (${p.qtdUn} un)</p>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="addAoCarrinho(${p.id}, 0)" class="bg-blue-600/10 p-3 rounded-xl flex-1 border border-blue-500/10 hover:bg-blue-600/20 active:scale-95 transition-all">
                            <span class="block text-[8px] font-black text-blue-400">UNID.</span>
                            <span class="text-xs font-black">R$ ${p.precoUn.toFixed(2)}</span>
                        </button>
                        ${p.packs.map((pack, idx) => `
                            <button onclick="addAoCarrinho(${p.id}, ${idx + 1})" class="bg-amber-600/10 p-3 rounded-xl flex-1 border border-amber-500/10 hover:bg-amber-600/20 active:scale-95 transition-all">
                                <span class="block text-[8px] font-black text-amber-500">PACOTE ${pack.un}</span>
                                <span class="text-xs font-black">R$ ${pack.preco.toFixed(2)}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        função adicionarAoCarrinho(prodId, packIdx) {
            const p = db.estoque.find(x => x.id === prodId);
            deixe item = { prodId: p.id, nome: p.nome };
            se(packIdx === 0) {
                if(p.qtdUn < 1) return showToast("Sem Estoque", p.nome, "erro");
                item.label = "UNID"; item.preco = p.precoUn; item.custo = p.custoUn; item.desconto = 1;
            } outro {
                const pack = p.packs[packIdx - 1];
                if(p.qtdUn < pack.un) return showToast("Estoque Insuficiente", "Pacote cancelado", "erro");
                item.label = `PACOTE ${pack.un}`; item.preco = pack.preco; item.custo = p.custoUn * pack.un; item.desconto = pack.un;
            }
            carrinho.push(item);
            renderCarrinho();
        }

        função renderCarrinho() {
            const cont = document.getElementById('carrinhoLista');
            cont.innerHTML = carrinho.map((c, idx) => `
                <div class="flex justify-between items-center bg-slate-950/80 p-4 rounded-2xl border border-white/5">
                    <div class="flex flex-col"><span class="text-[9px] font-black text-slate-400 uppercase">${c.nome}</span><span class="text-xs font-black text-blue-500">${c.label} • R$ ${c.preco.toFixed(2)}</span></div>
                    <button onclick="carrinho.splice(${idx},1); renderCarrinho();" class="text-red-500/50 p-2"><i class="fas fa-trash"></i></button>
                </div>`).join('');
            const total = carrinho.reduce((a, b) => a + b.preco, 0);
            document.getElementById('displayCartTotal').textContent = `R$ ${total.toFixed(2)}`;
            const btn = document.getElementById('btnFinalizar');
            btn.disabled = carrinho.length === 0;
            btn.className = `w-full py-5 rounded-2xl font-black uppercase text-[11px] ${carrinho.length > 0 ? 'bg-blue-600 text-white shadow-xl shadow-blue-500/20 hover:bg-blue-500' : 'bg-slate-800 text-slate-500'}`;
        }

        função finalizarVenda() {
            tente { document.getElementById('audioVenda').play(); } catch(e){}
            const total = carrinho.reduce((a, b) => a + b.preco, 0);
            const lucro = carrinho.reduce((a, b) => a + (b.preco - b.custo), 0);
            
            carrinho.forEach(item => {
                const p = db.estoque.find(x => x.id === item.prodId);
                if(p) p.qtdUn -= item.desconto;
            });

            constObj = {
                id: Date.now(),
                total,
                lucro,
                dados: novo Date().toLocaleString('pt-PT'),
                itens: [...carrinho]
            };

            db.vendas.unshift(vendaObj);
            últimaVenda = vendaObj; // Guarda para usar no modal
            
            carrinho = [];
            salvar();
            renderCarrinho(); // Limpa UI do carrinho
            
            // Abre Modal Pós Venda
            alternarModal('modalPosVenda');
        }

        function u.relayTxt() {
            if (!db.vendas || db.vendas.length === 0) return showToast("Aviso", "Sem vendas para exportar");
            let conteudo = "--- RELATÓRIO DE VENDAS CH GELADAS ---\n";
            conteudo += `Gerado em: ${new Date().toLocaleString('pt-PT')}\n\n`;
            db.vendas.forEach((v, i) => {
                conteudo += `VENDA #${v.id} | DADOS: ${v.dados}\n`;
                v.itens.forEach(item => { conteudo += `- ${item.nome} (${item.label}): R$ ${item.preco.toFixed(2)}\n`; });
                conteudo += `TOTAL: R$ ${v.total.toFixed(2)}\n---------------------------------------\n`;
            });
            const blob = new Blob([conteudo], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `vendas_ch_geladas_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // --- FINANCEIRO AVANÃ‡ADO ---
        função renderizarFinanciário() {
            const container = document.getElementById('vendaLogs');
            document.getElementById('totalVendasCount').textContent = `${db.vendas.length} reg`;
            
            container.innerHTML = db.vendas.map(v => `
                <div class="bg-black/20 p-4 rounded-2xl flex justify-between items-center group transition-all hover:bg-slate-900/80 border border-white/5">
                    <div class="flex flex-col gap-1">
                        <span class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">${v.data}</span>
                        <div class="flex items-center gap-2">
                             <span class="text-sm font-black text-white">R$ ${v.total.toFixed(2)}</span>
                             <span class="text-[9px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-400">${v.itens.length} itens</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="abrirEditorVenda(${v.id})" class="w-8 h-8 rounded-lg bg-blue-500/10 text-blue-500 flex items-center justify-center hover:bg-blue-500 hover:text-white transition-all">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        <button onclick="excluirVenda(${v.id})" class="w-8 h-8 rounded-lg bg-red-500/10 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // Atualizar métricas
            const bruto = db.vendas.reduce((a, b) => a + b.total, 0);
            const lucro = db.vendas.reduce((a, b) => a + b.lucro, 0);
            const inv = db.investimento || 0;
            document.getElementById('dashLucro').textContent = `R$ ${lucro.toFixed(2)}`;
            document.getElementById('faturacaoBruta').textContent = `R$ ${bruto.toFixed(2)}`;
            document.getElementById('roiDisplay').textContent = inv > 0? `${((lucro / inv) * 100).toFixed(1)}%` : '0%';
            document.getElementById('breakEvenStatus').textContent = lucro >= inv ? "Pago" : `Falta R$ ${(inv - lucro).toFixed(2)}`;
        }

        function abrirEditorVenda(id) {
            const venda = db.vendas.find(v => v.id === id);
            se(!venda) retornar;
            
            document.getElementById('editVendaId').value = venda.id;
            document.getElementById('editVendaData').value = venda.data;
            document.getElementById('editVendaTotal').value = venda.total;
            document.getElementById('editVendaLucro').value = venda.lucro;
            
            alternarModal('modalEditVenda');
        }

        function salvarEdicaoVenda() {
            const id = parseInt(document.getElementById('editVendaId').value);
            const novaData = document.getElementById('editVendaData').value;
            const novoTotal = parseFloat(document.getElementById('editVendaTotal').value);
            const novoLucro = parseFloat(document.getElementById('editVendaLucro').value);

            const idx = db.vendas.findIndex(v => v.id === id);
            se(idx !== -1) {
                db.vendas[idx].data = novaData;
                db.vendas[idx].total = novoTotal;
                db.vendas[idx].lucro = novoLucro;
                salvar();
                alternarModal('modalEditVenda');
                renderFinanceiro();
                showToast("Sucesso", "Venda atualizada");
            }
        }

        função gVenda(id) {
            const venda = db.vendas.find(v => v.id === id);
            se(!venda) retornar;

            if(confirm('Tem certeza que deseja EXCLUIR esta venda?\n\nO valor será removido da caixa.')) {
                //cartão sobre o estoque
                if(confirm('Deseja DEVOLVER os itens ao estoque?\n\nClique em OK para relatar os produtos.\nClique em Cancelar para apenas apagar o registro financeiro.')) {
                    venda.itens.forEach(item => {
                        const prod = db.estoque.find(p => p.id === item.prodId);
                        se(prod) {
                            prod.qtdUn += item.desconto; // item.desconto contém quantidade real retirada (1 ou embalagem)
                        }
                    });
                    showToast("Estoque", "Itens devolvidos");
                }
                
                db.vendas = db.vendas.filter(v => v.id !== id);
                salvar();
                renderFinanceiro();
                showToast("Venda Excluída", "Registro removido");
            }
        }

        // --- PONTO ---
        function registrarPonto(tipo) {
            const nome = document.getElementById('workerName').value;
            if(!nome) return showToast("Erro", "Insira o nome", "erro");
            db.ponto.unshift({ nome, tipo, dados: new Date().toLocaleString('pt-PT') });
            salvar();
            showToast("Ponto", `${nome} -> ${tipo}`);
        }

        função renderizarLogsPonto() {
            document.getElementById('pontoLogs').innerHTML = db.ponto.map(p => `
                <div class="bg-slate-900/50 p-4 rounded-2xl flex justify-between items-center border border-white/5">
                    <span class="text-[11px] font-bold">${p.nome}</span>
                    <div class="text-right">
                        <span class="block text-[8px] font-black ${p.tipo === 'ENTRADA' ? 'text-emerald-500' : 'text-red-500'}">${p.tipo}</span>
                        <span class="text-[9px] text-slate-500">${p.data}</span>
                    </div>
                </div>`).join('');
        }

        // --- ESSENCIAL ---
        função salvar() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
            if(document.querySelector('.tab-content.active').id === 'financeiro') renderFinanceiro();
            atualizarUI();
            atualizarEstatísticas();
        }

        função refreshUI() {
            renderizarCatálogo();
            // renderCarrinho(); // Não re-renderiza carrinho para não perder estado visual se não mudou
            renderPontoLogs();
            document.getElementById('gridEstoque').innerHTML = db.estoque.map(p => `
                <div class="bg-slate-900/50 p-5 rounded-2xl border border-white/5 relative group transition-all hover:bg-slate-900">
                    <div class="absolute top-4 right-4 flex gap-2">
                        <button onclick="editProduto(${p.id})" title="Editar" class="text-blue-500/40 hover:text-blue-400"><i class="fas fa-edit"></i></button>
                        <button onclick="if(confirm('Apagar ${p.nome}?')) { db.estoque = db.estoque.filter(x => x.id !== ${p.id}); save(); }" title="Apagar" class="text-slate-700 hover:text-red-500"><i class="fas fa-times-circle"></i></button>
                    </div>
                    <p class="label-blue !mb-2 !ml-0">${p.nome}</p>
                    <div class="flex justify-between items-end">
                        <div><span class="block text-[8px] text-slate-500 font-black">ESTOQUE</span><span class="text-2xl font-black">${p.qtdUn}</span></div>
                        <div class="text-right">
                            <span class="block text-[8px] text-slate-500 font-black">VENDA UM</span>
                            <span class="text-sm font-bold text-slate-400">R$ ${p.precoUn.toFixed(2)}</span>
                        </div>
                    </div>
                </div>`).join('');
        }

        função atualizarInvestimento() {
            db.investimento = parseFloat(document.getElementById('invTotalInput').value) || 0;
            salvar();
        }

        function updateClock() { document.getElementById('liveClock').textContent = new Date().toLocaleTimeString('pt-PT'); }
        
        função showToast(msg, sub, type = 'success') {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            document.getElementById('toastSubMsg').textContent = sub;
            const icon = document.getElementById('toastIcon');
            icon.className = `w-8 h-8 rounded-full flex items-center justify-center ${type === 'success' ? 'bg-blue-500/20 text-blue-500' : 'bg-red-500/20 text-red-500'}`;
            icon.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'times'} text-[10px]"></i>`;
            t.classList.remove('opacity-0', 'translate-y-20', 'pointer-events-none');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-20', 'pointer-events-none'), 3000);
        }

        função atualizarEstatísticas() {
            document.getElementById('statProds').textContent = db.estoque ? db.estoque.length : 0;
            document.getElementById('statVendas').textContent = db.vendas ? db.vendas.length : 0;
            document.getElementById('statPonto').textContent = db.ponto ? db.ponto.length : 0;
        }

        função resetSistema() {
            if(confirm('ATENÃO: Você está prestes a apagar TODOS os dados do sistema (Estoque, Vendas, Ponto, Financeiro).\n\nEssa ação não pode ser desfeita.')) {
                const check = prompt('Para confirmar a exclusão completa, digite a palavra "DELETAR" abaixo:');
                se(check === 'DELETAR') {
                    db = { estoque: [], vendas: [], ponto: [], investimento: 0, config: { whatsapp: '' } };
                    salvar();
                    showToast("Sistema Redefinido", "Todos os dados foram apagados", "erro");
                    setTimeout(() => location.reload(), 1500);
                } outro {
                    showToast("Cancelado", "Código de confirmação incorreto", "erro");
                }
            }
        }

        functionBackup() {
            const blob = new Blob([JSON.stringify(db)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CH_Geladas_BKP_${new Date().toISOString().split('T')[0]}.json`;
            a.clique();
            URL.revokeObjectURL(url);
            document.getElementById('lastBackupInfo').textContent = new Date().toLocaleString();
            showToast("Backup Criado", "Arquivo baixado");
        }

        funçãoDados(entrada) {
            const file = input.files[0];
            se (!arquivo) retornar;

            const leitor = novo FileReader();
            leitor.onload = função(e) {
                tentar {
                    const data = JSON.parse(e.target.result);
                    // Redefinimos a entrada para permitir selecionar o mesmo arquivo novamente caso haja erro
                    input.value = '';

                    if (data.estoque && Array.isArray(data.estoque)) {
                        if(confirm('ATENÃ‡ÃƒO: Isso substituirÃ¡ TODOS os dados atuais pelos do arquivo.\n\nTem certeza que deseja continuar?')) {
                             // Mesclamos com o DB atual para garantir que chaves novas (como configuração do zap) não quebrem com backups antigos
                             db = { ...db, ...dados };
                             salvar();
                             showToast("Sucesso", "Dados restaurados!");
                             setTimeout(() => location.reload(), 1500);
                        }
                    } outro {
                        showToast("Erro", "Arquivo inválido ou danificado", "erro");
                    }
                } catch (erro) {
                    input.value = '';
                    showToast("Erro", "Falha ao ler arquivo", "erro");
                    console.error(err);
                }
            };
            leitor.lerComoTexto(arquivo);
        }

        janela.onload = init;
    </script>
</body>
</html>
